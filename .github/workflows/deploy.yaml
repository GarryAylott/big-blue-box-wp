name: Deploy to 20i

on:
    push:
        branches:
            - main
    pull_request:
        types: [closed]
        branches:
            - main

jobs:
    deploy:
        # Only run on direct pushes to main OR when a PR is merged (not just closed)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build theme
              run: npm run build

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ssh.gb.stackcp.com >> ~/.ssh/known_hosts

            - name: Deploy via rsync
              run: |
                  rsync -avz --delete \
                    --exclude='node_modules/' \
                    --exclude='src/' \
                    --exclude='.git/' \
                    --exclude='.github/' \
                    --exclude='.gitignore' \
                    --exclude='package.json' \
                    --exclude='package-lock.json' \
                    --exclude='gulpfile.js' \
                    --exclude='webpack.config.cjs' \
                    --exclude='README.md' \
                    --exclude='AGENTS.md' \
                    --exclude='.claude/' \
                    --exclude='.nvmrc' \
                    --exclude='.prettierignore' \
                    --exclude='bigbluebox/' \
                    -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
                    ./ ${{ secrets.SSH_USER }}@ssh.gb.stackcp.com:${{ secrets.SSH_PATH }}

            - name: Cleanup
              if: always()
              run: rm -f ~/.ssh/deploy_key
